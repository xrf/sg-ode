{macros}
harness=$(HARNESS) timeout 15

all:

clean:
	rm -fr bin target *.*_out *.o *.o_mpi *.ok

check: check_ode bin/vector_test.ok

check_ode: {test_targets}

doc:
	doxygen

lint: {lint_targets}

# just an alias
test: check

.PHONY: all clean check check_ode doc lint test Makefile

{bins}

bin/vector_test.ok: bin/vector_test
	@mkdir -p $(@D)
	$(harness) $(MPIEXEC) -np 4 bin/vector_test
	@touch $@

vector_macros.h: vector_macros.py_out
	./vector_macros.py_out

.SUFFIXES: .c .o .o_mpi .py .py_out .txt .txt_out

.c.o:
	mkdir -p $(@D)
	$(CC) $(CPPFLAGS) $(CFLAGS) -c -o $@ $<

.c.o_mpi:
	mkdir -p $(@D)
	$(MPICC) $(CPPFLAGS) $(CFLAGS) -c -o $@ $<

.py.py_out:
	mkdir -p $(@D)
	cp -p $< $@

.txt.txt_out:
	mkdir -p $(@D)
	cp -p $< $@

Makefile:
	@[ ! -x ./config.status ] || ./config.status

{lints}
{tests}
{deps}
