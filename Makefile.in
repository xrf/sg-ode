{macros}
LIBS=-lm
harness=$(HARNESS) timeout 15

all: check

clean:
	rm -fr bin target *.o *.o_mpi *.ok

check: bin/ode_test.ok bin/vector_test.ok

doc:
	doxygen

lint: {lint_targets}

.PHONY: all clean check doc lint Makefile

{bins}

bin/ode_test.ok: bin/ode_test ode_demo.txt_out
	@mkdir -p $(@D)
	$(harness) bin/ode_test >ode_test.out
	@git --no-pager diff --exit-code --no-index ode_test.out ode_demo.txt_out
	@touch $@

bin/vector_test.ok: bin/vector_test
	@mkdir -p $(@D)
	$(harness) mpiexec -np 4 bin/vector_test
	@touch $@

vector_macros.h: vector_macros.py_out
	./vector_macros.py_out

.SUFFIXES: .c .o .o_mpi .py .py_out .txt .txt_out

.c.o:
	$(CC) $(CPPFLAGS) $(CFLAGS) -c -o $@ $<

.c.o_mpi:
	$(MPICC) $(CPPFLAGS) $(CFLAGS) -c -o $@ $<

.py.py_out:
	cp -p $< $@

.txt.txt_out:
	cp -p $< $@

Makefile:
	@[ ! -x ./config.status ] || ./config.status

{lints}
{deps}
